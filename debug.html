<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Debug Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .success { background: #d4edda; border-color: #c3e6cb; }
    .error { background: #f8d7da; border-color: #f5c6cb; }
    .info { background: #d1ecf1; border-color: #bee5eb; }
    input, button {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      margin-top: 20px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Auth Debug Tool</h1>
    <p>This tool will help us identify what's wrong with your authentication.</p>

    <!-- Library Check -->
    <div class="test-section" id="library-check">
      <h3>üìö Library Check</h3>
      <p>Checking if Supabase library is loaded...</p>
    </div>

    <!-- Connection Test -->
    <div class="test-section" id="connection-test">
      <h3>üåê Connection Test</h3>
      <button onclick="testConnection()">Test Supabase Connection</button>
      <p id="connection-result">Click button to test</p>
    </div>

    <!-- Auth Test -->
    <div class="test-section" id="auth-test">
      <h3>üîê Authentication Test</h3>
      <input type="email" id="test-email" placeholder="test@example.com" value="test@example.com">
      <input type="password" id="test-password" placeholder="password123" value="password123">
      <br>
      <button onclick="testSignup()">Test Signup</button>
      <button onclick="testLogin()">Test Login</button>
      <button onclick="testGetUser()">Check Current User</button>
      <p id="auth-result">Ready for testing</p>
    </div>

    <!-- Live Log -->
    <div class="test-section">
      <h3>üìã Live Log</h3>
      <button onclick="clearLog()">Clear Log</button>
      <div id="log"></div>
    </div>
  </div>

  <!-- Load Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <script>
    // Your Supabase config
    const supabaseUrl = "https://ebtwbgbkvimfdvolbyaa.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVidHdiZ2JrdmltZmR2b2xieWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNjczNjUsImV4cCI6MjA3Mjc0MzM2NX0.WW_LpmgYwYbY2gt8deNifqxsKmylfhMzlroKlvZY4lU";
    
    let supabase = null;
    
    // Logging function
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logDiv = document.getElementById('log');
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
      logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`${prefix} ${message}`);
    }
    
    function clearLog() {
      document.getElementById('log').textContent = '';
    }

    // Check library loading
    window.addEventListener('load', () => {
      const libraryCheck = document.getElementById('library-check');
      
      if (window.supabase) {
        log('Supabase library loaded successfully', 'success');
        libraryCheck.className = 'test-section success';
        libraryCheck.innerHTML = '<h3>üìö Library Check</h3><p>‚úÖ Supabase library loaded successfully!</p>';
        
        try {
          supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
          log('Supabase client created successfully', 'success');
        } catch (err) {
          log('Error creating Supabase client: ' + err.message, 'error');
          libraryCheck.className = 'test-section error';
          libraryCheck.innerHTML = '<h3>üìö Library Check</h3><p>‚ùå Error creating Supabase client: ' + err.message + '</p>';
        }
      } else {
        log('Supabase library failed to load', 'error');
        libraryCheck.className = 'test-section error';
        libraryCheck.innerHTML = '<h3>üìö Library Check</h3><p>‚ùå Supabase library failed to load!</p>';
      }
    });

    // Test signup with automatic retry
    async function testSignupWithRetry() {
      const resultDiv = document.getElementById('retry-result');
      const email = 'test' + Date.now() + '@gmail.com'; // Unique email
      
      log(`Testing signup with retry logic using: ${email}`);
      resultDiv.textContent = 'üîÑ Attempting signup with auto-retry...';
      
      const maxRetries = 3;
      const baseDelay = 2000; // 2 seconds
      
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          log(`Attempt ${attempt}/${maxRetries}...`);
          
          const { data, error } = await supabase.auth.signUp({
            email: email,
            password: 'password123'
          });
          
          if (error) {
            log(`Attempt ${attempt} failed: ${error.message}`, 'error');
            
            if (error.status === 503 && attempt < maxRetries) {
              const delay = baseDelay * attempt;
              log(`Waiting ${delay}ms before retry...`);
              resultDiv.textContent = `‚è≥ Attempt ${attempt} failed (503), retrying in ${delay/1000}s...`;
              await new Promise(resolve => setTimeout(resolve, delay));
              continue;
            } else {
              resultDiv.textContent = `‚ùå All attempts failed: ${error.message}`;
              return;
            }
          } else {
            log(`Success on attempt ${attempt}!`, 'success');
            resultDiv.textContent = `‚úÖ Success on attempt ${attempt}! User created: ${email}`;
            document.getElementById('retry-test').className = 'test-section success';
            return;
          }
        } catch (err) {
          log(`Attempt ${attempt} error: ${err.message}`, 'error');
          if (attempt === maxRetries) {
            resultDiv.textContent = `‚ùå All attempts failed: ${err.message}`;
          }
        }
      }
    }

    // Check project health
    async function checkProjectStatus() {
      const resultDiv = document.getElementById('retry-result');
      log('Checking project health...');
      
      try {
        // Test multiple endpoints
        const tests = [
          { name: 'Auth Session', test: () => supabase.auth.getSession() },
          { name: 'Auth User', test: () => supabase.auth.getUser() },
        ];
        
        let allPassed = true;
        
        for (const { name, test } of tests) {
          try {
            log(`Testing ${name}...`);
            const result = await test();
            if (result.error) {
              log(`${name} failed: ${result.error.message}`, 'error');
              allPassed = false;
            } else {
              log(`${name} passed`, 'success');
            }
          } catch (err) {
            log(`${name} error: ${err.message}`, 'error');
            allPassed = false;
          }
        }
        
        if (allPassed) {
          resultDiv.textContent = '‚úÖ Project health looks good - issue might be temporary';
        } else {
          resultDiv.textContent = '‚ö†Ô∏è Some project health checks failed';
        }
        
      } catch (err) {
        log('Health check error: ' + err.message, 'error');
        resultDiv.textContent = '‚ùå Health check failed: ' + err.message;
      }
    }

    // Test connection
    async function testConnection() {
      const resultDiv = document.getElementById('connection-result');
      log('Testing connection to Supabase...');
      
      try {
        if (!supabase) {
          throw new Error('Supabase client not initialized');
        }
        
        const { data, error } = await supabase.auth.getSession();
        
        if (error) {
          log('Connection test failed: ' + error.message, 'error');
          resultDiv.textContent = '‚ùå Connection failed: ' + error.message;
          document.getElementById('connection-test').className = 'test-section error';
        } else {
          log('Connection test successful', 'success');
          resultDiv.textContent = '‚úÖ Connection successful!';
          document.getElementById('connection-test').className = 'test-section success';
        }
      } catch (err) {
        log('Connection test error: ' + err.message, 'error');
        resultDiv.textContent = '‚ùå Connection error: ' + err.message;
        document.getElementById('connection-test').className = 'test-section error';
      }
    }

    // Test signup
    async function testSignup() {
      const email = document.getElementById('test-email').value;
      const password = document.getElementById('test-password').value;
      const resultDiv = document.getElementById('auth-result');
      
      log(`Testing signup with email: ${email}`);
      resultDiv.textContent = 'üîÑ Testing signup...';
      
      try {
        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password
        });
        
        log('Signup response: ' + JSON.stringify({ data, error }, null, 2));
        
        if (error) {
          log('Signup failed: ' + error.message, 'error');
          resultDiv.textContent = '‚ùå Signup failed: ' + error.message;
        } else {
          log('Signup successful!', 'success');
          if (data.user && !data.session) {
            resultDiv.textContent = '‚úÖ Signup successful! Email confirmation required.';
          } else if (data.session) {
            resultDiv.textContent = '‚úÖ Signup successful and logged in!';
          } else {
            resultDiv.textContent = '‚úÖ Signup response received but unclear status';
          }
        }
      } catch (err) {
        log('Signup error: ' + err.message, 'error');
        resultDiv.textContent = '‚ùå Signup error: ' + err.message;
      }
    }

    // Test login
    async function testLogin() {
      const email = document.getElementById('test-email').value;
      const password = document.getElementById('test-password').value;
      const resultDiv = document.getElementById('auth-result');
      
      log(`Testing login with email: ${email}`);
      resultDiv.textContent = 'üîÑ Testing login...';
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        log('Login response: ' + JSON.stringify({ data, error }, null, 2));
        
        if (error) {
          log('Login failed: ' + error.message, 'error');
          resultDiv.textContent = '‚ùå Login failed: ' + error.message;
        } else {
          log('Login successful!', 'success');
          resultDiv.textContent = '‚úÖ Login successful!';
        }
      } catch (err) {
        log('Login error: ' + err.message, 'error');
        resultDiv.textContent = '‚ùå Login error: ' + err.message;
      }
    }

    // Test get user
    async function testGetUser() {
      const resultDiv = document.getElementById('auth-result');
      
      log('Testing get current user...');
      resultDiv.textContent = 'üîÑ Checking current user...';
      
      try {
        const { data, error } = await supabase.auth.getUser();
        
        log('Get user response: ' + JSON.stringify({ data, error }, null, 2));
        
        if (error) {
          log('Get user failed: ' + error.message, 'error');
          resultDiv.textContent = '‚ùå Get user failed: ' + error.message;
        } else if (data.user) {
          log('User found: ' + data.user.email, 'success');
          resultDiv.textContent = '‚úÖ Current user: ' + data.user.email;
        } else {
          log('No user currently logged in');
          resultDiv.textContent = '‚ÑπÔ∏è No user currently logged in';
        }
      } catch (err) {
        log('Get user error: ' + err.message, 'error');
        resultDiv.textContent = '‚ùå Get user error: ' + err.message;
      }
    }

    log('Debug tool loaded. Click buttons to test functionality.');
  </script>
</body>
</html>